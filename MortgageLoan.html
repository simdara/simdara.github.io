<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	
	 <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js'></script>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Mortgage Loan Cal
    </title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {packages: ['corechart','table']});
	  google.charts.setOnLoadCallback(drawCharts);
	//

function drawCharts() {
	//
	// Input 1
	var loanAmount = document.getElementById("loanPrincipal").value/1.0; // loan principal
	// Input 2
	var IntRate = document.getElementById("IntRate").value/100; // interest rate
	if (IntRate<0 || IntRate>.9999) {
		alert('Interest rate must be positive and less than 100! However, '+numToStr(IntRate,'percent')+ ' is input!');
	} else if (loanAmount>=10000000 || loanAmount<0) {
		alert('Principal must be positive and below 100,000,000! However, '+numToStr(loanAmount,'decimal')+ ' is input!');
	} else {
		// Option1 Chosen
		var FreqOption = [1, 12];// monthly, annually
		var Freqid = document.getElementById("MonOrAnn").selectedIndex;
		var mIntRate = IntRate/FreqOption[Freqid]; // monthly interest rate
		// Option2 Chosen
		var yearOption =[10,15,20];
		var mYid = document.getElementById("maxYear").selectedIndex;
		var mYear = yearOption[mYid];
		//
		// Create a datatable
		var DT = new google.visualization.DataTable();
		DT.addColumn('number', 'Payback Year'); // Year 
		DT.addColumn('number','Monthly Payment'); // monthly payment	
		DT.addColumn('number','Total Payment (Principal+Interest)');// total payment
		DT.addColumn('number','Total Interest');// Interest Only
		DT.addColumn('number','Principal');// Principal
		//
		DT.addColumn('string','MPaymentAnnnotations');//
		DT.addColumn('string','TPaymentAnnnotations');//
		DT.addColumn('string','YearString');// YearString
		for (var y = 1; y<mYear+1; y++) {
			var mPay_y = loanAmount*mIntRate/(1-Math.pow(1+mIntRate,-12*y)); // monthly payment
			var tPay_y = mPay_y*12*y; // total payment
			var IntOnly = tPay_y - loanAmount; // Interest only
			DT.addRow([y, mPay_y, tPay_y, IntOnly, loanAmount,
						numToStr(mPay_y,'decimal'), numToStr(tPay_y,'decimal'), y.toString()]);
		}
		// Draw Charts
		var chart1 = new google.visualization.ColumnChart(document.getElementById('chart1_div'));
		var option1 = {
			height: 320 + (20-mYear)*15,
			width: 900,
			title: 'Monthly payment for different payback year',
			vAxis: {title: 'Monthly Payment(USD)',gridlines:{count:12}},
			hAxis: {title: 'Year'},
			legend: {position:'none'},
			annotations:{ textStyle:{auraColor: 'white'}},
		};
		var table1 = new google.visualization.Table(document.getElementById('table1_div'));
		var tabOption = {
			width:'100%',
		};
		//
		numFormatter = new google.visualization.NumberFormat({prefix:'$',fractionDigits:0});
		numFormatter.format(DT,1);
		numFormatter.format(DT,2);
		numFormatter.format(DT,3);
		numFormatter.format(DT,4);
		// Data View
		DTview = new google.visualization.DataView(DT);

		// Table 1
		DTview.setColumns([0,4,1,2,3]);
		table1.draw(DTview,tabOption);
		//
		// Chart1
		DTview.setColumns([7,1,{sourceColumn:5,role:'annotation'}]);
		chart1.draw(DTview,option1);
		// Part 2
		constrPaybackYearOptions();
		constrPaidYearOptions();
	}
}
function drawTable2(){
	// Draw table2 for prepayment case
	// Input 1
	var loanAmount = document.getElementById("loanPrincipal").value/1.0; // loan principal
	// Input 2
	var IntRate = document.getElementById("IntRate").value/100; // interest rate
	var FreqOption = [1, 12];// monthly, annually
	var Freqid = document.getElementById("MonOrAnn").selectedIndex;
	var mIntRate = IntRate/FreqOption[Freqid]; // monthly interest rate
	// Inputs
	var selectedPaybackYear = document.getElementById("FixedPaybackYear").value;
	var selectedPaidYear	= document.getElementById("PaidYear").value;
	var Penalty	= document.getElementById("PrepaymentPenalty").value;
		//
	if (Penalty >loanAmount) {
		alert('Prepayment Penalty is bigger than loan amount!');
	} 
	// MOnthly payment for the selectedPaybackYear
	var mPay = loanAmount*mIntRate/(1-Math.pow(1+mIntRate,-12*selectedPaybackYear)); // monthly payment
	document.getElementById("pre_mp").innerHTML = "Monthly Payment is "+ numToStr(mPay,"decimal") + ".";
	//
	// Create a datatable
	var DT2 = new google.visualization.DataTable();
	DT2.addColumn('number', 'Prepayment happense after '+selectedPaidYear.toString()+' Years'+"...months"); // Months 
	DT2.addColumn('number','Remaining Balance'); // Remaining Balance	
	DT2.addColumn('number','Effective Interest Rate (%)');// Effective rate
	for (var m = 0; m<12; m++) {
		var mm = 12*selectedPaidYear+m; // Prepayment happens after mm months
		var RemBal_m = loanAmount*Math.pow(1+mIntRate,mm) + mPay*(1-Math.pow(1+mIntRate,mm))/mIntRate;  
		// Cashflow array
		var cfA = [loanAmount];
		for (var i=1; i<mm;i++) {
			cfA.push(mPay*(-1));
		}
		cfA.push(-mPay-RemBal_m-Penalty);
		//

		DT2.addRow([m, RemBal_m, IRR(cfA,mIntRate)*12*100]);
	}
	//
	numFormatter = new google.visualization.NumberFormat({prefix:'$',fractionDigits:0});
	numFormatter.format(DT2,1);
	// Table2
	var table2 = new google.visualization.Table(document.getElementById('table2_div'));
	var tabOption = {
		width:'100%',
	};
	table2.draw(DT2,tabOption);
}
function NPV(cfArray,r) {
	// find NPV for a cash flow array and interest rate r
	var ncf = cfArray.length;
	var NPVal = 0.0;
	for (n=0;n<ncf; n++) {
		NPVal+=cfArray[n]/Math.pow(1+r,n);
	}
	return NPVal;
}
function IRR(cfArray,guest){
	// Inputs: 
	//	1. cfArray is a cashflow array
	// 2. guest for IRR
	// If cfArray[0] > 0 , NPV is increasing function of interest rate; else, NPV is decreasing function of interest rate
	// we consider NPL is increasing function of r only
	// Set tolerance for NPV
	npvTol = 0.000001;
	//
	if (guest<=0) {alert('The interest rate should be positive!');}
	//
	if (NPV(cfArray,guest*1.1)-NPV(cfArray,guest)<0) {cfArray = cfArray*(-1.0);}// if decreasing, make it increasing
	//
	var ra = guest*1.0;
	var rb = guest*1.0;
	// find rate at positive NPV
	do {
		rb *=1.1;
		NPV_rb = NPV(cfArray,rb);
	}
	while (NPV_rb<0);
	// find rate at negative NPV
	do {
		ra *=0.9;
		NPV_ra = NPV(cfArray,ra);
	}
	while (NPV_ra>0);
	//
	do {
		// IRR Candidate
		IRRC = ra - NPV_ra*(rb-ra)/(NPV_rb-NPV_ra); // interpolation
		NPV_IRRC = NPV(cfArray,IRRC);
		if (Math.abs(NPV_IRRC)<npvTol) {return IRRC;}
		else {
			if (NPV_IRRC<0) {ra = IRRC; NPV_ra = NPV(cfArray,ra);} 
			else { rb = IRRC; NPV_rb = NPV(cfArray,rb);}
		}
	}
	while (Math.abs(NPV_IRRC)>npvTol);
}
function alertMessage()
{
    alert(document.getElementById('loanPrincipal').value);
}
function constrPaybackYearOptions(){
	//
	var yearOption =[10,15,20];
	var mYid = document.getElementById("maxYear").selectedIndex;
	var mYear = yearOption[mYid];
	var YearOption = document.forms[1].FixedPaybackYear;
	YearOption.length=0;
	for (var y=1;y<=mYear;y++) {
		YearOption[y-1]= new Option(y,y,false,false);
	}
	YearOption[mYear-1] = new Option(mYear,mYear,false,true);
}
function constrPaidYearOptions(){
	//
	var FPayYear = document.getElementById("FixedPaybackYear").options[document.getElementById("FixedPaybackYear").selectedIndex].value;
	var YearOption = document.forms[1].PaidYear;
	YearOption.length=0;
	for (var y=1;y<=FPayYear-1;y++) {
		YearOption[y-1]= new Option(y,y,false,false);
	}
	YearOption[FPayYear-2] = new Option(FPayYear-1,FPayYear-1,false,true);
}
function numToStr(num,fo){
	if (num==null){return null;}
	if (fo=='decimal') {
		return '$'+num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");;
	} else {
		return (num*100).toFixed(2)+'%';
	}
} 
	</script>
<style>
html {
	display: table;
	margin: auto;
}

body {
	display: table-cell;
	font-family: Georgia;
	width:900px;
	padding:10px;
}
#filterLicense_div{
	width:100%;
	padding:3px;
}
#filterName_div{
	width:100%;
	padding:3px;
}
#filterYear_div{
	width:100%;
	padding:3px;
}

#dashboard{
	background-color:rgb(234,242,248);
	padding-left:20px;
	border-radius: 15px;
}

footer {background-color:rgba(23,32,42,0.5);
		color:white;
		font-size:14px;
		margin-top:10px;
		padding:1px;
		text-align:center;
}
header {text-align: left;
		//background-color:#F5EEF8;
		border-radius: 5px;
		color:#273746;
		margin-bottom:10px;
		padding-left:2px;
		padding-bottom:10px;
		padding-top:10px;
		font-size:25px;
		font-weight:bold;
}
h3{
	//background-color:#F4F6F6;
	border-radius: 2px;
	//color:#2E86C1;
	color:#8E44AD;
}
#Setting{
	//background-color:rgb(212,230,241);
	//color:#4A235A;
	border-radius: 2px;
	padding:3px;
	//font-weight:bold;
}
option{
	padding:5px 0;
}
#chart1_div{
	display:block;
	margin:0 auto !important;
}

select{
	font-family: Georgia;
	font-size:100%;
}
.google-visualization-table-td {
text-align: center !important;
}
<!-- *** Site map STYLE *** -->
#SiteMap {
	//background-color:rgb(234,242,248);
	//border-radius: 15px;
	height:30px;
}

#SiteLinks {
	padding: 0px;
	background-color:rgb(234,242,248);
	border-radius: 5px;
	height:30px;
}
#SiteLinks ul {
   margin: 0;
   padding: 0;    
}
#SiteLinks li {
    float: left;
    list-style-type: none;
}
#SiteLinks li a {
    padding: 5px 5px;
    margin: 0 3px 0 0;
	display:block;
	text-decoration: none;
	color:blue;
	//border-right:1px solid white;
}
#SiteLinks li a:hover {
	text-decoration: bold;
	background-color:#0000FF;
	color:white;
	text-decoration: underline;
}
br.clearLeft {
   clear: left;        
}​
<!-- **************************** -->
</style>
  </head>
  <body>
  <header>
	Mortgage Loan Calculator Ver 1.0
</header>
<h4><i> Last update: October 14, 2017 </i></h4>
<!-- First Part --->
<h3>What is the fixed <em> monthly payment</em> for a given loan principal, monthly interest rate, and payback year? </h3>
<!-- Input part -->
<div id="Inputs"> 
	<!-- -->
	<form>
	<fieldset>
	<legend>Mortgage Loan Info:</legend>
		Principal Amount: USD
		<input type="number" id="loanPrincipal" min="0" max="10000000" step="1000" value="100000" align="right">
		</br>
		</br>
		Interest Rate:
		<input type="number" id="IntRate" min="0" max="100" step="0.1" value="10"> % &nbsp;
		<select id="MonOrAnn">
		<option value="Monthly">Monthly</option>
		<option value="Annually" selected>Annually</option>
		</select>
		</br>
		</br>
		Max Payback Year: 
		<select id="maxYear" onchange="drawCharts()">
			<option value="10" selected>10</option>
			<option value="15">15</option>
			<option value="20">20</option>
		</select> &nbsp; years
		</br>
	</fieldset>
	</form>
</div>
</br>
<div id="Cal">
<button type="button" onclick="drawCharts()" id="btn">Calculate</button>
</div>
<!-- Result Part---->
</br>
<div id="table1">
	<div id="table1_div"> </div>
</div>
</br>
<div id="chart1">
	<div id="chart1_div"> </div>
</div>
</br>

<!-- Second Part --->
<h3>What is the effective interest rate in the case of Prepayment or Refinancing?</h3>
<h4> 1. Prepayment </h4>
<!-- Input part for Prepayment-->
<div id="Inputs"> 
	<!-- -->
	<form>
	<fieldset>
	<legend>Prepayment Info:</legend>
		Loan terms are the same as about with selected payback year: 
		<select id="FixedPaybackYear" onchange="constrPaidYearOptions()">
			<option>10</option>
		</select> &nbsp; years
		</br>
		</br>
		Prepayment happens after: 
		<select id="PaidYear">
			<option>9</option>
		</select> &nbsp; years
		</br>
		</br>
		Prepayment Penalty Amount: USD
		<input type="number" id="PrepaymentPenalty" min="0" max="10000000" step="1000" value="3000" align="right">
		</br>
		</br>

	</fieldset>
	</form>
</div>
</br>
<div id="Cal">
<button type="button" onclick="drawTable2()" id="btn2">Calculate</button>
</div>
<!-- Result Part---->
<p id="pre_mp"></p>
<div id="table2">
	<div id="table2_div"> </div>
</div>
<!-- *** Site Map *** -->
<div id="SiteMap">
	<div id="SiteLinks">
		<ul>
			<li><a href="https://simdara.github.io/index">Home</a></li>
			<li><a href="https://simdara.github.io/BankingDBViewer" >Banking-Database</a></li>
			<li><a href="https://simdara.github.io/MortgageLoan">Mortgage-Cal</a></li>
			<li><a href="https://simdara.github.io/PPAP">PPAP</a></li>
			<li><a href="http://www.yuantacambodia.com/">YSC</a></li>

		</ul>    
		<br class="clearLeft" />
	</div>
</div>

<footer>Copyright &copy; 2017, Yuanta Securities (Cambodia) Plc.</footer>
</body>
</html>
